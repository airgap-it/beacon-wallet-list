name: Purge jsDelivr CDN Cache

on:
  push:
    branches:
      - main

jobs:
  purge-cdn:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          else
            CHANGED_FILES=$(git ls-files)
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Purge dist files from jsDelivr
        run: |
          echo "Purging wallet list files from jsDelivr CDN..."
          for file in dist/*.json; do
            URL="https://purge.jsdelivr.net/gh/airgap-it/beacon-wallet-list@main/$file"
            echo "Purging: $file"
            curl -s "$URL" || echo "Failed to purge $file"
          done
          echo "âœ“ CDN cache purge complete"
